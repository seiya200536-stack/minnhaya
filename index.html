<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>„Åø„Çì„ÅØ„ÇÑÁ∑¥Áøí„Ç¢„Éó„É™</title>
    <style>
        :root {
            --primary: #3498db; --accent: #e67e22; --star: #f1c40f;
            --bg: #f4f7f6; --text: #333; --panel-bg: #ffffff;
            --danger: #e74c3c; --sub: #95a5a6;
        }
        html, body {
            overflow-x: hidden; width: 100%; position: relative;
            touch-action: pan-y; -webkit-user-select: none; user-select: none;
            margin: 0; padding: 0; background: var(--bg);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; color: var(--text); padding-bottom: 80px; box-sizing: border-box; }
        nav { 
            background: #2c3e50; padding: calc(env(safe-area-inset-top) + 10px) 10px 10px 10px;
            display: flex; justify-content: center; gap: 8px; width: 100%; box-sizing: border-box; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        nav button { background: none; border: 1px solid #7f8c8d; color: #bdc3c7; padding: 8px 14px; border-radius: 20px; cursor: pointer; font-weight: bold; outline: none; font-size: 0.9rem;}
        nav button.active { background: white; color: #2c3e50; border-color: white; }
        .container { width: 95%; max-width: 600px; margin: 10px auto; background: white; padding: 15px; border-radius: 12px; display: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); box-sizing: border-box; outline: none; }
        .container.active { display: block; }
        
        .review-header { 
            position: sticky; top: 0; background: white; z-index: 900; padding: 10px 15px; 
            margin: -15px -15px 10px -15px; border-bottom: 2px solid #f4f7f6; 
            display: flex; justify-content: space-between; align-items: center; border-radius: 12px 12px 0 0;
        }

        /* „ÇØ„Ç§„Ç∫ÁîªÈù¢„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ÔºàÊ®ôÊ∫ñ„Çµ„Ç§„Ç∫„Å´Âæ©Â∏∞Ôºâ */
        .quiz-action-area { display: flex; gap: 8px; align-items: stretch; margin-top: 10px; }
        .btn { border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .btn-main { background: var(--primary); color: white; font-size: 1rem; padding: 15px; width: 100%; }
        .btn-star { background: #ddd; color: white; font-size: 1.5rem; width: 60px; height: 50px; }
        .btn-copy-main { background: #7f8c8d; color: white; font-size: 1.2rem; width: 60px; height: 50px; }
        .btn-next { background: #2ecc71; flex: 1; height: 50px; font-size: 1rem; color: white; }
        .btn:disabled { background: #ccc !important; color: #999; cursor: not-allowed; }

        #question-display { font-size: 1.4rem; min-height: 100px; line-height: 1.6; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; word-break: break-all; }
        
        /* Âæ©ÁøíÁîªÈù¢ÔºàÊ®ôÊ∫ñ„Éê„É©„É≥„ÇπÔºâ */
        .review-item { border-bottom: 1px solid #eee; padding: 12px 0; cursor: pointer; transition: transform 0.3s ease, opacity 0.3s ease; position: relative; overflow: hidden; width: 100%; }
        .review-top-row { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 8px; width: 100%; }
        .review-q { font-size: 0.95rem; line-height: 1.4; color: #555; flex: 1; word-break: break-all; }
        .review-bottom-row { display: flex; align-items: center; justify-content: space-between; gap: 5px; pointer-events: none; width: 100%; }
        .rev-ans-box { flex: 1; }
        .rev-ans { color: var(--danger); font-weight: bold; font-size: 1.1rem; }
        .rev-controls { display: flex; gap: 4px; pointer-events: auto; }
        .btn-sm { padding: 6px 10px; border-radius: 4px; border: none; font-size: 0.75rem; font-weight: bold; cursor: pointer; }
        .btn-copy-sm { background: none; color: #999; font-size: 0.9rem; padding: 2px 4px; border: none; flex-shrink: 0; cursor: pointer; margin-top: 2px; }
        .hidden { display: none !important; }
    </style>
</head>
<body id="app-body" tabindex="0">

<nav>
    <button id="nav-setup" onclick="showScreen('setup')">Ë®≠ÂÆö</button>
    <button id="nav-quiz" onclick="showScreen('quiz')">„ÇØ„Ç§„Ç∫</button>
    <button id="nav-review" onclick="showScreen('review')">Âæ©Áøí</button>
</nav>

<div id="screen-setup" class="container active">
    <h3 style="margin-top:0;">üìÇ Ë®≠ÂÆö</h3>
    <div id="status" style="margin-bottom:15px; padding:15px; border-radius:8px; background:#dfe6e9; text-align:center; font-weight:bold;">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ</div>
    <input type="file" id="csv-file" accept=".csv" onchange="loadCSV(this)" style="width:100%; margin-bottom:20px;">
    <button class="btn btn-main" id="start-btn" onclick="initQuiz()" disabled>Á∑¥ÁøíÈñãÂßã (Enter)</button>
    <div style="margin-top:30px; border-top:1px solid #eee; padding-top:20px;">
        <button class="btn" onclick="exportAppHTML()" style="background:var(--accent); color:white; width:100%; padding:15px; border-radius:8px; font-weight:bold;">Âüã„ÇÅËæº„ÅøÊ∏à„ÅøHTML„Çí‰øùÂ≠ò</button>
        <button onclick="clearSystemData()" style="margin-top:20px; background:none; border:none; color:var(--sub); cursor:pointer; font-size:0.8rem; text-decoration:underline; width:100%;">ÂÖ®„Éá„Éº„ÇøÂâäÈô§</button>
    </div>
</div>

<div id="screen-quiz" class="container">
    <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#999; margin-bottom:5px;">
        <span id="info-count">Á¨¨ - Âïè</span>
        <span id="info-rest">ÊÆã: -</span>
    </div>
    <div id="question-display"></div>
    <button id="reveal-btn" class="btn btn-main" onclick="doReveal()">Ëß£Á≠îË°®Á§∫ (Enter)</button>
    <div id="quiz-footer" class="hidden">
        <div class="footer-area" style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:10px;">
            <div id="ans-text" style="color:var(--danger); font-size:1.4rem; font-weight:bold; text-align:center;"></div>
            <div id="ans-yomi" style="color:#666; text-align:center; font-size:0.8rem;"></div>
        </div>
        <div class="quiz-action-area">
            <button id="copy-btn-quiz" class="btn btn-copy-main" onclick="copyCurrentQuiz()">üìã</button>
            <button id="star-btn" class="btn btn-star" onclick="toggleFav()">‚òÜ</button>
            <button id="next-btn" class="btn btn-next" onclick="doNext()">Ê¨°„Å∏ (Enter)</button>
        </div>
    </div>
</div>

<div id="screen-review" class="container">
    <div class="review-header">
        <h3 style="margin:0; font-size: 1rem;">‚òÖ Âæ©ÁøíÂ∏≥ <span id="review-count" style="font-size:0.75rem; color:var(--sub); font-weight:normal;">(0)</span></h3>
        <button id="bulk-toggle-btn" onclick="toggleAllReview()" style="padding:6px 10px; cursor:pointer; background:#34495e; color:white; border:none; border-radius:5px; font-weight:bold; font-size:0.8rem;">ÂÖ®„Å¶Ë°®Á§∫</button>
    </div>
    <div id="review-list"></div>
</div>

<script>
    let savedQuizData = []; 
    const KEY_BASE_DATA = "quiz_system_data";
    const KEY_FAV = "quiz_fav_list";
    let quizQueue = [], qIdx = 0, isShowing = false, timer = null;
    let currentScreen = 'setup';
    let isAllRevealed = false; 

    const KEY_DATA = localStorage.getItem(KEY_BASE_DATA);
    if (KEY_DATA) savedQuizData = JSON.parse(KEY_DATA);
    else if (typeof embeddedData !== 'undefined') savedQuizData = embeddedData;

    window.onload = () => {
        if (savedQuizData && savedQuizData.length > 0) {
            updateStatusText(`„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÊ∏à„Åø: ${savedQuizData.length}‰ª∂`);
            document.getElementById('start-btn').disabled = false;
        }
        showScreen('setup');
    };

    function updateStatusText(txt) {
        const s = document.getElementById('status');
        if(s) { s.textContent = txt; s.style.background = "#d4edda"; s.style.color = "#155724"; }
    }

    function showScreen(name) {
        currentScreen = name;
        document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('screen-' + name).classList.add('active');
        document.getElementById('nav-' + name).classList.add('active');
        if(name === 'review') renderReview();
        window.scrollTo(0,0);
        document.getElementById('app-body').focus();
    }

    function loadCSV(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split(/\r\n|\n/);
            savedQuizData = lines.filter(l => l.trim()).map(l => {
                const c = l.split(',');
                return { q: c[0]||"", a: c[1]||"", y: c[2]||"" };
            });
            localStorage.setItem(KEY_BASE_DATA, JSON.stringify(savedQuizData));
            updateStatusText(`Ë™≠ËæºÂÆå‰∫Ü: ${savedQuizData.length}‰ª∂`);
            document.getElementById('start-btn').disabled = false;
        };
        reader.readAsText(file);
    }

    function initQuiz() {
        if(!savedQuizData || savedQuizData.length === 0) return;
        quizQueue = [...savedQuizData].sort(() => Math.random() - 0.5);
        qIdx = 0; showScreen('quiz'); loadQuestion();
    }

    function loadQuestion() {
        if (qIdx >= quizQueue.length) { alert("ÁµÇ‰∫Ü"); showScreen('setup'); return; }
        isShowing = false;
        const data = quizQueue[qIdx];
        document.getElementById('info-count').textContent = `Á¨¨ ${qIdx + 1} Âïè`;
        document.getElementById('info-rest').textContent = `ÊÆã: ${quizQueue.length - qIdx - 1}`;
        document.getElementById('reveal-btn').classList.remove('hidden');
        document.getElementById('quiz-footer').classList.add('hidden');
        const favs = getFavs();
        const isFav = favs.includes(data.q);
        const sBtn = document.getElementById('star-btn');
        sBtn.textContent = isFav ? "‚òÖ" : "‚òÜ";
        sBtn.style.background = isFav ? "var(--star)" : "#ddd";
        const display = document.getElementById('question-display');
        display.textContent = "";
        if(timer) clearInterval(timer);
        let charIdx = 0;
        timer = setInterval(() => {
            if(charIdx < data.q.length) display.textContent += data.q[charIdx++];
            else clearInterval(timer);
        }, 60);
    }

    function doReveal() {
        if(timer) clearInterval(timer);
        isShowing = true;
        const data = quizQueue[qIdx];
        document.getElementById('question-display').textContent = data.q;
        document.getElementById('ans-text').textContent = data.a;
        document.getElementById('ans-yomi').textContent = data.y ? `(${data.y})` : "";
        document.getElementById('reveal-btn').classList.add('hidden');
        document.getElementById('quiz-footer').classList.remove('hidden');
    }

    function doNext() { qIdx++; loadQuestion(); }

    function toggleFav() {
        const data = quizQueue[qIdx];
        const favs = getFavs();
        const isAdd = !favs.includes(data.q);
        saveFav(data.q, isAdd);
        const sBtn = document.getElementById('star-btn');
        sBtn.textContent = isAdd ? "‚òÖ" : "‚òÜ";
        sBtn.style.background = isAdd ? "var(--star)" : "#ddd";
    }

    function copyCurrentQuiz() {
        const data = quizQueue[qIdx];
        const yomi = data.y ? ` (${data.y})` : "";
        const text = `${data.q} / ${data.a}${yomi}`;
        copyText(text, document.getElementById('copy-btn-quiz'));
    }

    async function copyText(text, btn) {
        try {
            await navigator.clipboard.writeText(text);
            const oldTxt = btn.textContent;
            btn.textContent = "‚úÖ";
            setTimeout(() => btn.textContent = oldTxt, 1000);
        } catch (err) { alert("Â§±Êïó"); }
    }

    function getFavs() {
        const stored = localStorage.getItem(KEY_FAV);
        return stored ? JSON.parse(stored) : [];
    }

    function saveFav(questionText, isAdd) {
        let favs = getFavs();
        if (isAdd) { if (!favs.includes(questionText)) favs.push(questionText); }
        else { favs = favs.filter(t => t !== questionText); }
        localStorage.setItem(KEY_FAV, JSON.stringify(favs));
    }

    function renderReview() {
        const list = document.getElementById('review-list');
        list.innerHTML = "";
        const favs = getFavs();
        document.getElementById('review-count').textContent = `(${favs.length})`;
        if(!favs.length) { list.innerHTML = "<p style='text-align:center;color:#999;padding:20px;'>Á©∫„Åß„Åô</p>"; return; }
        
        favs.forEach((txt) => {
            const item = savedQuizData.find(d => d.q === txt);
            const ansText = item ? item.a : "---";
            const yomiText = (item && item.y) ? ` (${item.y})` : "";
            const div = document.createElement('div');
            div.className = "review-item";
            const hiddenClass = isAllRevealed ? "" : "hidden";
            div.innerHTML = `
                <div class="review-top-row">
                    <button class="btn-copy-sm" title="„Ç≥„Éî„Éº">üìã</button>
                    <div class="review-q">${txt}</div>
                </div>
                <div class="review-bottom-row">
                    <div class="rev-ans-box"><span class="rev-ans ${hiddenClass}">${ansText}${yomiText}</span></div>
                    <div class="rev-controls">
                        <button class="btn-sm toggle-btn" style="background:${isAllRevealed?'var(--sub)':'var(--primary)'};color:white;">${isAllRevealed?'Èö†„Åô':'Ë°®Á§∫'}</button>
                        <button class="btn-sm delete-btn" style="background:var(--danger);color:white;">ÂâäÈô§</button>
                    </div>
                </div>`;
            
            div.onclick = () => toggleThisAns(div);
            div.querySelector('.delete-btn').onclick = (e) => { e.stopPropagation(); removeReviewElement(div, txt); };
            div.querySelector('.btn-copy-sm').onclick = (e) => { 
                e.stopPropagation(); 
                const fullText = `${txt} / ${ansText}${yomiText}`;
                copyText(fullText, e.target);
            };

            let startX = 0;
            div.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; }, {passive: true});
            div.addEventListener('touchend', (e) => {
                let diff = startX - e.changedTouches[0].clientX;
                if (diff > 80) removeReviewElement(div, txt);
            }, {passive: true});

            list.appendChild(div);
        });
        syncBulkButton();
    }

    function toggleThisAns(div) {
        const ans = div.querySelector('.rev-ans');
        const btn = div.querySelector('.toggle-btn');
        if(!ans) return;
        const isHidden = ans.classList.toggle('hidden');
        btn.textContent = isHidden ? "Ë°®Á§∫" : "Èö†„Åô";
        btn.style.background = isHidden ? "var(--primary)" : "var(--sub)";
    }

    function removeReviewElement(div, txt) {
        div.style.transform = "translateX(-120%)"; div.style.opacity = "0";
        setTimeout(() => {
            div.remove(); saveFav(txt, false);
            const favs = getFavs();
            document.getElementById('review-count').textContent = `(${favs.length})`;
            if(favs.length === 0) { 
                document.getElementById('review-list').innerHTML = "<p style='text-align:center;color:#999;'>Á©∫„Åß„Åô</p>"; 
                isAllRevealed = false; syncBulkButton(); 
            }
        }, 300);
    }

    function toggleAllReview() {
        const items = document.querySelectorAll('.review-item');
        if(!items.length) return;
        isAllRevealed = !isAllRevealed;
        items.forEach(div => {
            const ans = div.querySelector('.rev-ans');
            const btn = div.querySelector('.toggle-btn');
            ans.classList.toggle('hidden', !isAllRevealed);
            btn.textContent = isAllRevealed ? "Èö†„Åô" : "Ë°®Á§∫";
            btn.style.background = isAllRevealed ? "var(--sub)" : "var(--primary)";
        });
        syncBulkButton();
    }
    
    function syncBulkButton() {
        document.getElementById('bulk-toggle-btn').textContent = isAllRevealed ? "ÂÖ®„Å¶Èö†„Åô" : "ÂÖ®„Å¶Ë°®Á§∫";
    }

    function moveTopToBottom() {
        const list = document.getElementById('review-list');
        const first = list ? list.firstElementChild : null;
        if (!first || !first.classList.contains('review-item')) return;
        const ans = first.querySelector('.rev-ans');
        const btn = first.querySelector('.toggle-btn');
        if(ans) ans.classList.add('hidden');
        if(btn) { btn.textContent = "Ë°®Á§∫"; btn.style.background = "var(--primary)"; }
        const txt = first.querySelector('.review-q').textContent;
        let favs = getFavs();
        const idx = favs.indexOf(txt);
        if (idx !== -1) { favs.splice(idx, 1); favs.push(txt); localStorage.setItem(KEY_FAV, JSON.stringify(favs)); }
        list.appendChild(first);
    }

    function clearSystemData() { if(confirm("ÂÖ®ÂâäÈô§Ôºü")) { localStorage.clear(); location.reload(); } }

    function exportAppHTML() {
        let html = document.documentElement.outerHTML;
        const dataScript = `const embeddedData = ${JSON.stringify(savedQuizData)};`;
        if (html.includes('const embeddedData =')) {
            html = html.replace(/const embeddedData = \[.*\];/, dataScript);
        } else {
            html = html.replace(/let savedQuizData = \[\];/, `let savedQuizData = [];\n    ${dataScript}`);
        }
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([html], {type: 'text/html'})); a.download = 'QuizApp_v160.html'; a.click();
    }

    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT') return;
        if (e.key === "ArrowRight" || e.key === "ArrowLeft") {
            const screens = ["setup", "quiz", "review"];
            let idx = (screens.indexOf(currentScreen) + (e.key === "ArrowRight" ? 1 : -1) + 3) % 3;
            showScreen(screens[idx]);
            return;
        }
        if (currentScreen === "setup") {
            if (e.key === "Enter" && !document.getElementById('start-btn').disabled) { e.preventDefault(); initQuiz(); }
        } else if (currentScreen === "quiz") {
            if (e.key === "Enter") { e.preventDefault(); if(!isShowing) doReveal(); else doNext(); }
            else if (e.key === "Shift") { e.preventDefault(); if(isShowing) toggleFav(); }
        } else if (currentScreen === "review") {
            if (e.key === "Enter") { e.preventDefault(); const f = document.querySelector('.review-item'); if(f) toggleThisAns(f); } 
            else if (e.key === "Shift") { e.preventDefault(); moveTopToBottom(); } 
            else if (e.key === "Delete" || e.key === "Backspace") {
                e.preventDefault(); const f = document.querySelector('.review-item');
                if(f) removeReviewElement(f, f.querySelector('.review-q').textContent);
            }
        }
    });
</script>
</body>
</html>
